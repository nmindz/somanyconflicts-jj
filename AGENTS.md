# AGENTS.md — Claude Code Configuration

## Repository Overview

**So Many Conflicts (JJ)** — A VSCode extension for interactively resolving Jujutsu (JJ) conflicts. Groups related conflicts, suggests resolution order and strategy, and supports JJ's N-way conflict format.

Fork of [So Many Conflicts](https://github.com/Symbolk/somanyconflicts) by Bo Shen ([@Symbolk](https://github.com/Symbolk)), adapted for JJ by Evandro Camargo ([@nmindz](https://github.com/nmindz)).

## Build / Test Commands

```bash
pnpm install          # Install deps (postinstall builds tree-sitter WASM parsers)
pnpm run compile      # Type-check (tsc --noEmit) + esbuild bundle → dist/extension.js
pnpm run check-types  # Type-check only (tsc --noEmit)
pnpm run watch        # Continuous compilation (esbuild watch + tsc watch in parallel)
pnpm run lint         # ESLint with cache (src/**/*.ts)
pnpm run test         # Full suite: compile + lint + run Mocha via vscode-test
pnpm run package      # Production bundle (minified, no sourcemaps)
npx @vscode/vsce package  # Package as VSIX for distribution
```

Debug: Press **F5** in VSCode to launch Extension Development Host.

### Running Single Test

No single-test runner. Tests run as a Mocha suite via `pnpm run test` (`node ./out/test/runTest.js`).
Test files: `src/test/suite/*.test.ts`. Test harness: `src/test/runTest.ts` + `src/test/suite/index.ts`.

### Build Pipeline

Two output directories:

- **`dist/`** — esbuild bundle (runtime). Entry: `dist/extension.js`. WASM parsers copied to `dist/parsers/`.
- **`out/`** — tsc output (used by test runner). Generated by `tsc` during test pre-step.

The `package.json` `"main"` points to `"./dist/extension.js"` (esbuild output).

## Code Style Guidelines

### TypeScript

- **Strict mode**: `"strict": true` in tsconfig
- **Target**: ES6 / CommonJS modules
- **No semicolons** — enforced by `@typescript-eslint/semi: ["error", "never"]`
- **No member delimiters** in multiline interfaces/types (no `;` or `,`)
- **Trailing commas** in multiline expressions (warn level)
- **Space before function parens**: `named: never`, `anonymous: always`, `asyncArrow: always`
- **Type annotation spacing**: enforced by `@typescript-eslint/type-annotation-spacing`
- Unused vars: error (but `args: none` — unused function params allowed)

### Imports

- VSCode API: `import * as vscode from "vscode"`
- Internal: relative paths, no extensions (`./Parser`, `./Conflict`)
- CommonJS `require` for non-TS packages: `const Graph = require('@dagrejs/graphlib').Graph`
- Named imports for types/classes: `import { Parser } from './Parser'`

### Naming Conventions

| Element             | Convention                         | Example                                                      |
| ------------------- | ---------------------------------- | ------------------------------------------------------------ |
| Classes             | PascalCase                         | `Conflict`, `ConflictSide`, `Parser`                         |
| Interfaces          | `I` prefix                         | `ISection`                                                   |
| Type aliases        | PascalCase                         | `ConflictSideType`, `NamingConvention`                       |
| Constants (markers) | UPPER_SNAKE_CASE                   | `conflictMarkerStart` (exception: namespaced in `Constants`) |
| Regex patterns      | camelCase                          | `conflictStartPattern`                                       |
| Methods/functions   | camelCase                          | `resolveFromDiff`, `getBaseLines`                            |
| Private fields      | `_` prefix                         | `_lines`, `_range`, `_type`                                  |
| Files               | PascalCase matching primary export | `Conflict.ts`, `Parser.ts`                                   |

### Class Pattern

- Private fields with `_` prefix, public getters/setters
- Constructor initializes all fields
- Methods use `public` access modifier explicitly

### Error Handling

- VCS operations use `child_process.execSync("jj ...")` with try/catch
- User-facing errors via `vscode.window.showErrorMessage()`
- Info messages via `vscode.window.showInformationMessage()`

## Key Architecture

### Parser State Machine (`src/Parser.ts`)

Five states: `OutsideConflict` → `AwaitingSection` → `DiffHeader` → `DiffContent` → `LiteralContent`

- Transitions on JJ markers (`<<<<<<<`, `%%%%%%%`, `+++++++`, `>>>>>>>`)
- `\\\\\\\` (7 backslashes) is an optional description line after `%%%%%%%`
- Produces `Conflict` objects with dynamic `sides[]` array

### Conflict Model (`src/Conflict.ts`)

- `_sides: ConflictSide[]` — dynamic array, NOT fixed ours/base/theirs
- `computeRanges()` — calculates line ranges for each side
- `getBaseContent()` — extracts base from diff sections

### ConflictSide Types (`src/ConflictSide.ts`)

- `diff` type: has `diffLines` (unified diff with +/-/space prefixes), `description`
- `literal` type: has `lines` (raw content, no prefix)
- `resolveFromDiff()` — applies diff to base to get resolved content
- `getBaseLines()` — extracts base content (lines without `+` prefix)
- `getContentLines()` — gets resolved content (lines without `-` prefix)

### Strategy System (`src/Strategy.ts`)

- `buildStrategies(sideCount, namingConvention)` — factory for N-way strategies
- `getStrategyCount(sideCount)` — returns total strategy count for given side count
- Supports `jj-native` ("Side 1", "Side 2") and `git-friendly` ("Current", "Incoming") naming

### File Discovery (`src/FileUtils.ts`)

- Primary: `jj resolve --list` via `child_process.execSync`
- Fallback: recursive file scan for JJ conflict markers (`<<<<<<<`)
- Controlled by `somanyconflicts-jj.scanMode` setting

### Extension Entry Point (`src/extension.ts`)

- Registers all `somanyconflicts-jj.*` commands
- Provides CodeLens (`ConflictLensProvider`) with per-side "Accept" actions
- TreeView (`ConflictTreeView`) for grouped and all conflicts
- Detects JJ conflicts on file open/save

### Build System (`esbuild.mjs`)

- esbuild bundles `src/extension.ts` → `dist/extension.js` (CJS format)
- Copies WASM parser files to `dist/parsers/` and `web-tree-sitter.wasm` to `dist/`
- `vscode` is externalized (provided by VSCode runtime)

## File Organization

```
somanyconflicts-jj/
├── src/                        # TypeScript source
│   ├── extension.ts            # VSCode extension entry point
│   ├── Parser.ts               # JJ conflict parser (5-state machine)
│   ├── Conflict.ts             # Conflict model (N-way sides[])
│   ├── ConflictSide.ts         # Side types: diff | literal
│   ├── ConflictSection.ts      # Resolution tracking per section
│   ├── Strategy.ts             # Dynamic resolution strategies
│   ├── FileUtils.ts            # JJ file discovery (CLI + fallback)
│   ├── AlgUtils.ts             # Similarity/dependency algorithms
│   ├── SoManyConflicts.ts      # Main logic: scan, graph, suggestions
│   ├── ConflictLensProvider.ts # CodeLens provider (Accept Side actions)
│   ├── ConflictTreeView.ts     # Sidebar tree view
│   ├── Constants.ts            # JJ marker constants and regex
│   ├── ISection.ts             # Section interface
│   ├── TextSection.ts          # Text section model
│   ├── MutexUtils.ts           # Mutex utilities
│   ├── Symbol.ts               # Symbol extraction
│   ├── Identifier.ts           # Identifier resolution
│   ├── Language.ts             # Language detection
│   ├── StringUtils.ts          # String utilities
│   └── test/                   # Test suite (Mocha + vscode-test)
│       ├── runTest.ts          # Test launcher
│       └── suite/
│           ├── index.ts        # Mocha runner config
│           └── extension.test.ts
├── parsers/                    # Pre-built WASM parsers (java, js, python, ts)
├── dist/                       # esbuild output (gitignored)
├── out/                        # tsc output for tests (gitignored)
├── esbuild.mjs                 # esbuild config + WASM copy logic
├── scripts/build.js            # WASM parser build script (postinstall)
├── media/                      # Icons and screenshots
├── _jj-conflicts/              # Reference JJ conflict examples
├── package.json                # Extension manifest + scripts
├── tsconfig.json               # TypeScript config (strict, ES6, CommonJS)
├── .eslintrc.yml               # ESLint config (standard + @typescript-eslint)
└── .vscode/launch.json         # Debug/launch configs
```

## Critical Rules

1. **No Git dependencies**: This extension uses `jj` CLI exclusively. Never import `simple-git` or any Git library. All VCS interaction goes through `child_process.execSync("jj ...")`.

2. **Command prefix**: All VSCode commands MUST use `somanyconflicts-jj.*` prefix (not `somanyconflicts.*`).

3. **N-way conflict support**: NEVER assume exactly 2 or 3 sides. Always iterate `conflict.sides` dynamically. The number of sides can be arbitrary.

4. **Configuration IDs**: All settings use `somanyconflicts-jj.*` prefix.

5. **Backslash constant**: In `Constants.ts`, the 7-backslash marker (`\\\\\\\`) requires careful escaping. The string literal needs 14 characters (`"\\\\\\\\\\\\\\\\"`) to produce 7 backslashes.

6. **No commits without review**: Never commit and push changes without handing control to the user for review.

## Attribution

- **Original author**: Bo Shen ([@Symbolk](https://github.com/Symbolk)) — [So Many Conflicts](https://github.com/Symbolk/somanyconflicts)
- **Conflict parsing inspiration**: Angelo Mollame ([@angelo-mollame](https://github.com/angelo-mollame)) — [Conflict Squeezer](https://github.com/angelo-mollame/conflict-squeezer)
- **JJ adaptation**: Evandro Camargo ([@nmindz](https://github.com/nmindz))
