# Contributing to So Many Conflicts (JJ)

Thank you for your interest in contributing! This project is a fork of [So Many Conflicts](https://github.com/Symbolk/somanyconflicts) adapted for the [Jujutsu (JJ)](https://jj-vcs.github.io/jj/) version control system.

## Development Setup

### Prerequisites

- **Node.js** ≥ 18.0.0
- **pnpm** ≥ 8.0.0
- **VSCode** (latest stable recommended)
- **Jujutsu (jj)** installed and on PATH (for testing with real conflicts)
- **wasi-sdk** (optional — auto-downloaded by tree-sitter-cli if not present; set `TREE_SITTER_WASI_SDK_PATH` to override)

### Getting Started

```bash
# Clone the repository
git clone https://github.com/nmindz/somanyconflicts-jj.git
cd somanyconflicts-jj

# Install dependencies (postinstall builds tree-sitter WASM parsers)
pnpm install

# Compile TypeScript
pnpm run compile
# This type-checks and bundles into dist/extension.js
```

## Running & Debugging

1. Open the project in VSCode.
2. Press **F5** to launch the Extension Development Host.
3. In the new window, open a JJ repository that has unresolved conflicts.
4. Commands are prefixed with `somanyconflicts-jj.*` — invoke via the Command Palette (`Cmd+Shift+P` / `Ctrl+Shift+P`) and type `somany`.

### Watch Mode

For continuous compilation during development:

```bash
pnpm run watch
```

## Running Tests

```bash
# Run the full test suite
pnpm run test

# Run linting
pnpm run lint
```

Tests use Mocha + vscode-test and run in a VSCode instance.

## Code Style

- **TypeScript strict mode** — `tsconfig.json` enforces strict checks
- **ESLint** — Run `pnpm run lint` before submitting; standard config with `@typescript-eslint`
- **No semicolons** — enforced by eslint standard config
- **Trailing commas** in multiline expressions
- **Single quotes** — enforced by ESLint
- **No Git dependencies** — all VCS interaction uses `jj` CLI via `child_process`, never `simple-git` or any Git library

## Architecture Overview

Understanding these core concepts will help you contribute:

- **Parser** (`src/Parser.ts`): 5-state machine that parses JJ conflict markers into `Conflict` objects
- **Conflict** (`src/Conflict.ts`): N-way conflict model with dynamic `sides[]` array (not fixed ours/base/theirs)
- **ConflictSide** (`src/ConflictSide.ts`): Two types — `diff` (unified diff from base) and `literal` (raw content)
- **Strategy** (`src/Strategy.ts`): Dynamic resolution strategies generated by `buildStrategies()` factory
- **FileUtils** (`src/FileUtils.ts`): File discovery via `jj resolve --list` or fallback file scanning
- **ConflictLensProvider** (`src/ConflictLensProvider.ts`): Provides CodeLens actions (Accept Side N, Accept All, Accept None, Show Related, Suggest Strategy) above each conflict
- **Build pipeline**: esbuild bundles `src/extension.ts` → `dist/extension.js` (runtime). tsc compiles to `out/` (tests only). WASM parsers are copied to `dist/parsers/`.

## Pull Request Process

1. **Fork** the repository and create a feature branch from `main`.
2. **Make your changes** following the code style guidelines above.
3. **Ensure quality**:
   - `pnpm run lint` passes with no errors
   - `pnpm run compile` succeeds with no TypeScript errors
   - `pnpm run test` passes (if tests exist for the changed area)
4. **Update documentation**:
   - Update `CHANGELOG.md` for new features or breaking changes
   - Update `README.md` if user-facing behavior changes
5. **Open a Pull Request** with a clear description of:
   - What changes were made and why
   - How to test the changes
   - Any breaking changes

## Important Guidelines

### N-Way Conflict Support

JJ supports N-way conflicts (not just 2-way or 3-way). When writing or modifying conflict handling code:

- **NEVER** hardcode assumptions about 2 or 3 sides
- **ALWAYS** iterate `conflict.sides` dynamically
- **ALWAYS** use `buildStrategies(sideCount)` for strategy generation

### Command Naming

All VSCode commands MUST use the `somanyconflicts-jj.*` prefix. Never use the old `somanyconflicts.*` prefix.

### Configuration Settings

All extension settings use the `somanyconflicts-jj.*` prefix.

## Adding Language Support

The extension uses [tree-sitter](https://tree-sitter.github.io/tree-sitter/) for syntax-aware conflict analysis. To add a new language:

1. Add the tree-sitter grammar as a dev dependency
2. Build the WASM parser (see `scripts/build.js`)
3. Place the `.wasm` file in `parsers/`
4. Update `src/Language.ts` to recognize the new language
5. Update `README.md` language support list

## Reporting Issues

When reporting bugs, please include:

- VSCode version
- Extension version
- JJ version (`jj --version`)
- OS and version
- Steps to reproduce
- Sample conflict file (if possible)

## Attribution

This project maintains proper attribution to its origins:

- **Original author**: [Bo Shen (@Symbolk)](https://github.com/Symbolk) — created the original [So Many Conflicts](https://github.com/Symbolk/somanyconflicts) extension
- **Conflict parsing**: Originally inspired by [Conflict Squeezer](https://github.com/angelo-mollame/conflict-squeezer) by [Angelo Mollame (@angelo-mollame)](https://github.com/angelo-mollame)
- **JJ adaptation**: [Evandro Camargo (@nmindz)](https://github.com/nmindz)

Please maintain these attributions in any derivative work.

## License

MIT — see [LICENSE](./LICENSE).
